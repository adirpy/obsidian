## 问题描述
生产环境eDesign同步IM时而报错

## 问题分析

### 失败场景
Planner发现设计数据有错误，申请在IM侧通过SQL脚本手工删除数据，由运维人员执行，由于删除脚本不够完整，导致IM侧产生垃圾数据，从而导致了后续的同步失败，主要分为以下几种失败场景：

1. 地址同步时，二级分光设备无法上连到OLT，返回同步失败结果。一般是由于成端或直熔数据无法组装出完整的逻辑LINK，为错误数据导致，占全部同步失败事件的90%以上。

2. 地址同步时，逻辑LINK所需要的端口已被占用，导致新的逻辑LINK无法生成，返回同步失败结果。一般是由于端口已被其它逻辑LINK所占用，为错误数据导致。

3. 同步数据量较大导致的IM返回EDN同步超时，从而使得同步失败。已提供代码优化方案。

4. 地址同步时，由于覆盖地址对应资源的设施数据（Chamber/Pole）缺失了其在Postgres数据表（plan_rent_facilit）中的res_id，导致发起同步时，覆盖表（IM_COVERED_ADDR）缺失FACILITY_ID字段的值，使得资源无法更新IM_FACILITY_HO表，导致同步失败。一般通过补齐设施的res_id，并补齐覆盖表的FACILITY_ID字段值解决。

5. 同步事件无原因阻塞，目前还没有查明。

6. 生成逻辑LINK所需的上行链路资源不完整，导致无法生成逻辑LINK。原因为设计人员没有同步上行资源导致，属于客户业务上的操作问题。

7. 一、二级分光器的分光比不符合资源设置的规则，导致IM返回EDN同步失败，属于客户业务上的操作问题。

8. 由于相关功能无法使用、消息无法发送、接口无法调用、锁表等导致的同步失败，一般为环境、应用异常、人为操作所导致，通过恢复异常场景并重新触发同步解决。

### 原因分析
由于数据问题导致的同步失败，最常见的情况为两类:

1. 存量的成端或直熔数据错误，导致资源无法使用这些成端或直熔数据生成完整的逻辑LINK，返回同步失败。对于该问题，一般是由于在对资源做删除操作时，只删除了对应的资源，而没有将资源关联的成端或直熔数据一并删除导致。对应“**同步失败常见错误**”的第**一**点。

2. 由于逻辑LINK占用了某个端口，导致该端口无法在重新生成LINK时被使用，返回同步失败。这一般是由于，在对资源做删除操作时，只删除了对应的资源，而没有考虑到资源已被逻辑LINK所占用，并将其关联逻辑LINK删除而释放其关联的端口。对应“**同步失败常见错误**”的第**二**点。

此外，还有不会触发同步失败，但存在异常的数据场景。目前发现的有——

1. 存量中存在一个到多个同名资源。这一般是由于，在对资源的同步做操作时，没有将需要删除的已同步实例进行删除，而只删除了EDN-IM之间关于资源的映射记录（即EDN_SYNC_DETAIL表记录）。导致EDN后续对该资源发起重复同步时，判断该资源还没有在IM侧生成，使得IM创建出新的同名实例。

地址在地址表（IM_ADDRESS）的状态（COVERAGE_TYPE）为可用（A），但没有完整的覆盖链路（LINK）。可能是由于做资源删除操作时，删除了资源关联的逻辑LINK，但没有对逻辑LINK覆盖到的地址进行信息的同步回滚，使得出现了状态可用但没有完整覆盖链路的地址存在。


### 其余可能的问题
由于还有其余的场景进行IM的修改，而这些修改都没有更新到eDesign，可能会造成问题，具体包括：
![https://d.pr/i/T1Kzmw+](https://d.pr/i/T1Kzmw+)

如图所示，除了添加OLT板卡和删除OLT板卡，其余操作都没有进行反向同步，如果对一个是由eDesign同步过来的数据进行了修改，而没有反向同步，则可能报错。


## 数据修复方案
### 针对列举场景的数据修复方案
x`
**参考武哥的文档**
AP: 提供比较结果 -- 徐新凯 【4/6】
      3S/7S/9S 需要确定定义 -- 周杨【x3/31】


### 修复后的完整的数据比对：
最后由于手工操作已经较长时间，中间可能有的数据错误没有在同步过程中体现，但是为了保证数据的一致性，这里需要对比完整的从eDesign入网的数据在IM和在eDesign的不同，进行对应的修复，从而保证在修复完成后，eDesign和IM处于同一个正确的状态。



## 完整解决方案

1. 针对目前已经有的手工修复的场景，提供功能进行修复，不允许手工进行修复。主要涉及资源删除，因为目前是限制了由edn同步过来的资源不允许删除，从而需要线下操作。这里需要提供后台服务或者页面隐藏功能来进行操作，不再手工进行操作。
	需要列出所有的需要的功能。

3. Feeder/Distribution的地址同步时完整端到端链路检查在Building方案也需要进行。

4. Feeder/Distriubtion/Building方案进行资源同步时，需要需要进行上行链路SPLICE单的检查。必须保证上行链路的SPLICE单都已经处理完成才允许发起。业务上这样也是合理的，因为资源同步的时候，必然已经处理完OTDR单，而OTDR单的原则就是要求上行链路已经处理完SPLICE单。
	
	BUILDING方案则重点在于上行的Feeder/Distribution方案的SPLICE单判断。
	
	【注意：】这里无法应对在检查完成后，在CO方案的ODF内进行分光器放置的情况。考虑到实际不会存在这种情况，暂时不考虑。
	
	这样进行上行链路检查的时候，就可以判断当前链路中的分光器的情况，进行L1分光器的分光比和L2分光器的分光比的检查。这部分加入EDN_SYS_ARG表配置，分别为L1_SPL_RATIO和L2_SPL_RATIO，取值为OPBS_DICT_VALUE表的DICT_ID= 'EDN.SPLITTER_RATIO'的值。保存到EDN_SYS_ARG表时，支持多个，用逗号隔开。
	
	检查通过后，需要对IM_SPLT的SPLITTER_LEVEL字段进行赋值。

	目前资源发现处理同步时的分光器级别的逻辑改为判断IM_SPLT的SPLITTER_LEVEL字段。老数据则统一根据1:4设置为L1，其余设置为L2进行完整更新。

	IM侧不再做业务检查，检查如果必须，在eDesign进行处理。

4. 错误提示给eDesign后，eDesign需要支持当前同步任务的重新发起。从而支持用户接受到错误信息后，可以手工修改后进行处理的情况。

5. 目前IM允许修改的情况包括：
	* 删除OLT板卡
	* 新增OLT板卡
	* 删除连接
	* 新建连接
	* 删除地址覆盖
	* 新增地址覆盖
	这些地方都需要进行反向同步。后续的原则是，尽量以eDesign作为修改为准，除非客户明确要求从IM修改。

	IM中其余的编辑功能，都需要考虑Disable


  
  
剥离SOC和下面的POC和LINK，分配只考虑PON Bear，不再生成POC。整体方案【武哥描述】


1. EDN/IM分工边界 （IM ： OLT-ODF 和无源侧的跳纤，EDN：无源侧物理资源）
2. 提供功能做数据修复，而不是客服脚本
3. 开通的时候，不占用L2分光器上行的数据，方便设计人员进行调整错误数据