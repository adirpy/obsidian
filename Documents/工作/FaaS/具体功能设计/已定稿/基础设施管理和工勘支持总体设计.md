## 一、现状描述

管道网的管理，目前主要分为两类：
1.  管道网是第三方管理，运营商只是对管道网进行租用，这里又分为两种情况：
	1. 运营商在设计之初就从租用方拿到数据进行导入，比较适合管道网属于一个租用方的情况
	2. 需要运营商自行工勘，工勘了解是哪个租用方后，然后分别到对应的租用方进行申请，比较适合管道网分属于多个租用方的情况
		在这种情况下，一般不进行管道网的内部设计。
2.  管道网由运营商进行管理，这种也分为两种情况：
	1. 管道网有内部详情，这种情况下，根据运营商提供数据的方式，也分为两类：
		* 以底图的形式进行提供
		* 通过和运营商的资源系统进行对接进行提供
	2.  管道网只有路由，位置数据，没有内部详情，这种情况下，数据一般只以底图的形式进行提供。

然后从实际业务使用上来看，管道网作为一个已经存在的信息，应该是全局的，任何人都可以随时使用。应对到系统中应该是属于在网资源或者地貌来进行管理。但是在实际的设计体验来说，需要使用到的包括选中，吸附等操作，从而应该是设计资源。

目前系统中，我们存在四个管道网图层：

-  设计图层，对应WFS服务，操作方便
-  其余工程设计图层，对应WMS服务
-   在网图层，对应WMS服务
-   地貌图层，这个目前只在HO项目中才有使用，但以后存在租用管道的情况会越来越多，WMS服务。

当如果设计图层和地貌图层很容易造成用户的困扰，很多功能处理上也会出现多个管道网图层的选项，所以，需要进行下统一。

## 二、总体定义

总体思路是将管道网分为三种管理方式：
* 设计图层，采用WFS服务，方便操作
* 其余设计图层，对应WMS服务，需要使用，需要做引用操作
* 地貌图层（现网PIA），采用WMS服务，性能保证

即不在进行资源层面的在网管道的对接，所有在网管道，无论是租用，还是自建，无论是IM接口对接，还是文件导入，第三方对接等，都在地貌图层进行对接

提供按照单个资源来进行转换的功能，主要用于将设计的新建管道网和现存的管道网相连接。

工勘（eSurvey/导入），对应操作的都是地貌图层。

入网，对应GIS对象，也进入地貌图层。

## 三、具体修改汇总

### 1.  地图配置

根据项目需求，来定义具体的地图的管道网地貌图层。包括：管道，竿路，人井，电杆，产品默认使用如下表名：

* 电杆：xxx_pole
* 人井：xxx_mh
* 管道：xxx_duct
* 杆路：xxx_air_wire
* 沟：xxx_trench

其中，xxx表示具体的国家，比如哥伦比亚地图就使用columbia_pole这样的表名
而HO，由于已经有plan_rent_facility和plan_rent_fac_sect表，则继续使用即可。目前对应的分别是manhole和duct。

需要管理的系统属性（即必须存在，业务逻辑使用的字段），请参考：
https://dev.iwhalecloud.com/doc/bidcgFRqU/didqonaARx

配置表中注意edns_surface_cat的RES_TYPE表示对应的资源规格ID

### 2. 工勘需要支持管道网地貌的工勘，这里逻辑保持一致

在eSurvey上图标尽量和eDesign保持一致。

### 3. 现网管道网功能

* 转换：
当当前方案中存在对应的设计管网图层的时候，现网管网的点对象（电杆，人井）提供转换的按钮，支持增加一个设计图层对象的功能。由于现网管网数据和设计管网数据都存在RES_ID字段，则通过次字段来表示同一个对象，同时设计管网的数据的source_flag记为U(和引用利旧区分），表示使用全局地貌数据。

查找对应的逻辑：
1. 根据当前图层的资源类型，在edns_surface_cat表中查找，类似sql如下：
	```sql
	select surface_cat from edns_surface_cat where res_type = ?
	```

2. 在地貌对应的图层中，去查找对应的数据。

### 4. 其余功能

铺缆，穿缆等关系功能需要支持设计管道网数据和现存管道网数据